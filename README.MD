
# Тестовое задание BotHelp.io


## Пояснение
Я не имею много опыта с очередями и "большими нагрузками", - возможно есть техники получше.  Пока не вижу другого решения, кроме увеличения количества consumers очереди.
  
Однако очереди гарантируют порядок, только при наличии единственного consumer и судя по гуглу, нет идеального решения задачи сохранения порядка при > 1 consumer.  

Частично обойти эту проблему можно с помощью consistent hashing. Все сообщения каждого аккаунта направляются только в одну очередь, соответствующую хэшу его id.

"Частично" потому что теоретически или статистически метод должен равномерно распределить по очередям сообщения, а на практике непонятно. Эксперименты показывают, что некоторые очереди получают больше задач. Еще один минус - распределение задач не зависит от текущей загрузки очередей. 

## Запуск
```shell script
# Создаст экземпляр RabbitMQ и 10 workers.
sudo docker-compose up -d --scale bothelp_worker=10  

# Отправит нужно количество сообщений пользователям в случайном порядке.
# Сообщения будут иметь порядковый номер. Лог будет выдаваться в консоль worker-ов и в файл `var/output.txt`
sudo docker-compose exec bothelp_worker php send.php  
sudo docker-compose exec bothelp_worker php send.php <maxAccounts> <maxMessages>
  
# Небольшой тест убедиться в том, что сообщения дошли в правильном порядке до каждого пользователя.
sudo docker-compose exec bothelp_worker php test-output.php  
```